# Vulnerable Apps

Each student cluster has intentionally vulnerable apps running which will be used during lab scenarios. The apps are available in following URLs. For Kind deployments, these are hosted on localhost.

```
http://mailbox-service.planetkesten.com
http://server-health.planetkesten.com
http://connectivity-check.planetkesten.com
```

**NOTE:** All attacks described in this document must be executed from Kubernetes Student VM or the docker-compose
student service. In either case, the ports inside the VM or container need to be mapped out to the host
and the kubectl port-forward must do so for all interfaces `--address 0.0.0.0`.

In the both of the following instructions, you need to have the k8s-training-kubeconfig file generated by the
`setup.sh` script. Either you generated this yourself, or your instructor created the cluster and will supply
you with it. 

```
Copy/paste the contents of the k8s-training-kubeconfig given to 
you into a file named k8s-training-kubeconfig in the HOME 
directory inside the VM or container. Be careful that 
the formatting is not messed up in the paste process.
```

The apps are accessible from Student VM after you setup port forward locally. 

## Student VM

First map the port 80 inside the VM which will be port-forwarding to the Kube API server to port 8090 (arbitrary)
outside the VM by creating an ssh tunnel. Do the following from a terminal or powershell.
```bash
ssh -L 8090:localhost:80 student@$STUDENTVMIP
```

Now at the student prompt.

```bash
sudo su
export KUBECONFIG=k8s-training-kubeconfig
kubectl port-forward -n kube-system --address 0.0.0.0 svc/nginx-ingress-controller 80:80
```

## Docker-compose student container
Similar to above, run 
```
docker-compose up -d
```
using the docker-compose.yml in k8s-workshop/infra-setup or copied
from the [Windows instructions](windows-instructions.md). Find the CONTAINERID with `docker ps`.
Exec into the container - `docker exec -it $CONTAINER_ID bash`. Then inside the container.
```
export KUBECONFIG=k8s-training-kubeconfig
kubectl port-forward -n kube-system --address 0.0.0.0 svc/nginx-ingress-controller 80:80
```

## Verify ports mapped correctly in the browser

Now when you point your browser running natively on the laptop to http://mailbox-service.planetkesten.com:8090 the following happens.
* The domain `mailbox-service.planetkesten.com` is resolved to 127.0.0.1
* The browser sends an HTTP request to 127.0.0.1:8090 which is forwarded to $STUDENTVMIP:80 via the ssh tunnel
* The kube port-forward proxy is listening on all interfaces on port 80 and forwarding to the Kube API server
* The host header sent to the Kube API server is `mailbox-service.planetkesten.com` so the kube-proxy knows
how to route it to the correct pod `mailbox-service` as defined in the `app-ingress.yaml` file.


Kind (verify this)
```bash
kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8090:80
```

You can verify everything worked as follows. It's ok for the ingress-nginx-controller ExternalIP to 
be in <pending> state.
```bash
kubectl get svc --all-namespaces
```

Now you can navigate to the vulnerable applications by URL given above.